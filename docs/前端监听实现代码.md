# 📱 前端监听实现代码

## 🎯 核心思路

将现有的轮询机制改为：
1. **数据库实时监听** - 主要方式
2. **订阅消息通知** - 后台提醒
3. **降频轮询** - 兜底方案

## 📝 代码实现

### 1. 修改 index.ts 的解析流程

```typescript
// miniprogram/pages/index/index.ts

// 解析按钮 - 新的异步流程
async onParse() {
  const url = (this.data.videoUrl || '').trim();
  if (!url) {
    this.showMessage('请输入视频链接', 'warning');
    return;
  }

  if (!this.validateVideoUrl(url)) {
    this.showMessage('请输入有效的视频链接', 'warning');
    return;
  }

  // 1. 请求订阅消息授权
  await this.requestSubscriptionPermission();

  // 2. 设置解析状态
  this.setData({ parsing: true });
  
  try {
    // 3. 提交任务到云函数
    this.showMessage('正在提交任务...', 'info');
    const taskResult = await wx.cloud.callFunction({
      name: 'extractText',
      data: { 
        action: 'createTask',
        input: url 
      }
    });

    const response = taskResult.result as any;
    if (!response || !response.success) {
      throw new Error(response?.error || '任务提交失败');
    }

    // 4. 立即反馈给用户
    this.setData({ parsing: false, videoUrl: '' });
    this.showMessage('任务已提交，处理完成后将通知您', 'success');
    
    // 5. 开始监听任务状态
    this.startTaskMonitoring(response.taskId);
    
  } catch (error: any) {
    console.error('提交任务失败:', error);
    this.setData({ parsing: false });
    this.showMessage(error.message || '提交失败，请重试', 'error');
  }
},

// 请求订阅消息授权
async requestSubscriptionPermission() {
  try {
    const app = getApp();
    const config = await app.waitForConfigReady();
    
    const templateIds = [
      config.subscriptionTemplateIds?.success || 'default_success_template_id',
      config.subscriptionTemplateIds?.failed || 'default_failed_template_id'
    ];
    
    const result = await wx.requestSubscribeMessage({
      tmplIds: templateIds
    });
    
    console.log('订阅消息授权结果:', result);
    return result;
  } catch (error) {
    console.error('订阅消息授权失败:', error);
    // 不阻断主流程
    return null;
  }
},

// 开始监听任务状态
startTaskMonitoring(taskId: string) {
  const db = wx.cloud.database();
  
  console.log('开始监听任务:', taskId);
  
  // 实时数据库监听
  const watcher = db.collection('tasks').doc(taskId).watch({
    onChange: (snapshot) => {
      if (snapshot.docs.length === 0) return;
      
      const task = snapshot.docs[0];
      console.log('任务状态更新:', task.status);
      
      this.handleTaskUpdate(task, watcher);
    },
    onError: (error) => {
      console.error('监听任务状态失败:', error);
      // 监听失败时启用轮询兜底
      this.startPollingFallback(taskId);
    }
  });
  
  // 设置监听超时（10分钟）
  setTimeout(() => {
    if (watcher) {
      watcher.close();
      console.log('任务监听超时，自动关闭');
    }
  }, 10 * 60 * 1000);
},

// 处理任务状态更新
handleTaskUpdate(task: any, watcher: any) {
  switch (task.status) {
    case 'processing':
      this.showMessage(`处理进度 ${task.progress || 0}%`, 'info');
      break;
      
    case 'completed':
      // 任务完成
      this.showTaskCompleted(task);
      watcher.close();
      break;
      
    case 'failed':
      // 任务失败
      this.showTaskFailed(task);
      watcher.close();
      break;
      
    case 'timeout':
      // 任务超时
      this.showMessage('解析超时，请重试', 'error');
      watcher.close();
      break;
  }
},

// 显示任务完成结果
showTaskCompleted(task: any) {
  console.log('任务完成:', task.result);
  
  this.setData({
    showResult: true,
    isContentUnlocked: false, // 重置解锁状态
    result: {
      cover: task.result.cover || '/static/imgs/index_icon.png',
      title: task.result.title || '未获取到标题',
      content: task.result.content || '未获取到内容',
      url: task.result.video_url || task.input_url
    }
  }, () => {
    this.updateDisplayContent();
  });
  
  this.showMessage('文案提取成功！', 'success');
  
  // 更新用户提取次数
  this.updateUserExtractCount();
},

// 显示任务失败
showTaskFailed(task: any) {
  const errorMessage = task.error_message || '解析失败，请重试';
  this.showMessage(errorMessage, 'error');
},

// 轮询兜底方案
startPollingFallback(taskId: string) {
  console.log('启用轮询兜底方案');
  
  let attempts = 0;
  const maxAttempts = 20; // 最多轮询20次（10分钟）
  
  const pollTimer = setInterval(async () => {
    attempts++;
    
    try {
      const db = wx.cloud.database();
      const result = await db.collection('tasks').doc(taskId).get();
      
      if (result.data) {
        const task = result.data;
        
        if (task.status === 'completed' || task.status === 'failed' || task.status === 'timeout') {
          clearInterval(pollTimer);
          this.handleTaskUpdate(task, null);
        }
      }
      
      if (attempts >= maxAttempts) {
        clearInterval(pollTimer);
        this.showMessage('解析超时，请重试', 'error');
      }
      
    } catch (error) {
      console.error('轮询查询失败:', error);
      
      if (attempts >= maxAttempts) {
        clearInterval(pollTimer);
        this.showMessage('网络异常，请重试', 'error');
      }
    }
  }, 30000); // 30秒轮询一次
}
```

### 2. 页面生命周期管理

```typescript
// miniprogram/pages/index/index.ts

// 页面显示时检查是否有未完成的任务
onShow() {
  this.checkPendingTasks();
},

// 检查用户是否有进行中的任务
async checkPendingTasks() {
  try {
    const db = wx.cloud.database();
    const result = await db.collection('tasks')
      .where({
        status: db.command.in(['pending', 'processing'])
      })
      .orderBy('created_at', 'desc')
      .limit(1)
      .get();
    
    if (result.data.length > 0) {
      const pendingTask = result.data[0];
      console.log('发现进行中的任务:', pendingTask._id);
      
      // 继续监听这个任务
      this.startTaskMonitoring(pendingTask._id);
      this.showMessage('检测到进行中的任务，继续监听...', 'info');
    }
  } catch (error) {
    console.error('检查待处理任务失败:', error);
  }
},

// 页面隐藏时的清理
onHide() {
  // 清理监听器
  if (this.taskWatcher) {
    this.taskWatcher.close();
    this.taskWatcher = null;
  }
},
```

### 3. 任务历史管理

```typescript
// 查看历史任务
async showTaskHistory() {
  try {
    const db = wx.cloud.database();
    const result = await db.collection('tasks')
      .orderBy('created_at', 'desc')
      .limit(10)
      .get();
    
    console.log('历史任务:', result.data);
    
    // 显示任务列表对话框
    const taskList = result.data.map(task => {
      const status = this.getTaskStatusText(task.status);
      const time = task.created_at.toLocaleString();
      return `${status} - ${time}`;
    });
    
    wx.showActionSheet({
      itemList: taskList,
      success: (res) => {
        const selectedTask = result.data[res.tapIndex];
        if (selectedTask.status === 'completed') {
          // 显示历史任务结果
          this.showHistoryTaskResult(selectedTask);
        }
      }
    });
    
  } catch (error) {
    console.error('获取历史任务失败:', error);
    this.showMessage('获取历史记录失败', 'error');
  }
},

// 获取任务状态文本
getTaskStatusText(status: string): string {
  const statusMap = {
    'pending': '等待中',
    'processing': '处理中',
    'completed': '已完成',
    'failed': '失败',
    'timeout': '超时',
    'cancelled': '已取消'
  };
  return statusMap[status] || '未知状态';
},
```

## 🎮 用户体验提升

### 1. 进度提示优化

```typescript
// 更丰富的进度提示
updateTaskProgress(task: any) {
  const progress = task.progress || 0;
  const statusMessages = {
    0: '正在排队等待处理...',
    20: '正在下载视频文件...',
    40: '正在分析视频内容...',
    60: '正在提取文案信息...',
    80: '正在生成最终结果...',
    100: '处理完成！'
  };
  
  const message = statusMessages[Math.floor(progress / 20) * 20] || `处理进度 ${progress}%`;
  this.showMessage(message, 'info');
}
```

### 2. 错误处理优化

```typescript
// 智能错误处理和重试
handleTaskError(task: any) {
  const retryCount = task.retry_count || 0;
  const maxRetries = 2;
  
  if (retryCount < maxRetries) {
    // 允许重试
    wx.showModal({
      title: '处理失败',
      content: `${task.error_message}\n\n是否重试？（还可重试 ${maxRetries - retryCount} 次）`,
      confirmText: '重试',
      cancelText: '取消',
      success: (res) => {
        if (res.confirm) {
          this.retryTask(task._id);
        }
      }
    });
  } else {
    // 重试次数已用完
    this.showMessage(`处理失败：${task.error_message}`, 'error');
  }
}
```

## 📊 性能监控

```typescript
// 监控任务处理时间
monitorTaskPerformance(task: any) {
  if (task.status === 'completed' && task.created_at && task.completed_at) {
    const processingTime = new Date(task.completed_at).getTime() - new Date(task.created_at).getTime();
    const seconds = Math.round(processingTime / 1000);
    
    console.log(`任务处理耗时: ${seconds}秒`);
    
    // 上报性能数据（可选）
    wx.reportMonitor('task_processing_time', seconds);
  }
}
```

这样实现后，用户体验将大大提升：
- ⚡ **立即反馈**：提交后立即告知用户任务已接收
- 🔔 **智能通知**：微信消息通知 + 实时数据监听
- 🔄 **容错处理**：多重兜底机制确保可靠性
- 📱 **后台处理**：用户可以关闭页面，不影响任务处理
