# ğŸ“± å‰ç«¯ç›‘å¬å®ç°ä»£ç 

## ğŸ¯ æ ¸å¿ƒæ€è·¯

å°†ç°æœ‰çš„è½®è¯¢æœºåˆ¶æ”¹ä¸ºï¼š
1. **æ•°æ®åº“å®æ—¶ç›‘å¬** - ä¸»è¦æ–¹å¼
2. **è®¢é˜…æ¶ˆæ¯é€šçŸ¥** - åå°æé†’
3. **é™é¢‘è½®è¯¢** - å…œåº•æ–¹æ¡ˆ

## ğŸ“ ä»£ç å®ç°

### 1. ä¿®æ”¹ index.ts çš„è§£ææµç¨‹

```typescript
// miniprogram/pages/index/index.ts

// è§£ææŒ‰é’® - æ–°çš„å¼‚æ­¥æµç¨‹
async onParse() {
  const url = (this.data.videoUrl || '').trim();
  if (!url) {
    this.showMessage('è¯·è¾“å…¥è§†é¢‘é“¾æ¥', 'warning');
    return;
  }

  if (!this.validateVideoUrl(url)) {
    this.showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„è§†é¢‘é“¾æ¥', 'warning');
    return;
  }

  // 1. è¯·æ±‚è®¢é˜…æ¶ˆæ¯æˆæƒ
  await this.requestSubscriptionPermission();

  // 2. è®¾ç½®è§£æçŠ¶æ€
  this.setData({ parsing: true });
  
  try {
    // 3. æäº¤ä»»åŠ¡åˆ°äº‘å‡½æ•°
    this.showMessage('æ­£åœ¨æäº¤ä»»åŠ¡...', 'info');
    const taskResult = await wx.cloud.callFunction({
      name: 'extractText',
      data: { 
        action: 'createTask',
        input: url 
      }
    });

    const response = taskResult.result as any;
    if (!response || !response.success) {
      throw new Error(response?.error || 'ä»»åŠ¡æäº¤å¤±è´¥');
    }

    // 4. ç«‹å³åé¦ˆç»™ç”¨æˆ·
    this.setData({ parsing: false, videoUrl: '' });
    this.showMessage('ä»»åŠ¡å·²æäº¤ï¼Œå¤„ç†å®Œæˆåå°†é€šçŸ¥æ‚¨', 'success');
    
    // 5. å¼€å§‹ç›‘å¬ä»»åŠ¡çŠ¶æ€
    this.startTaskMonitoring(response.taskId);
    
  } catch (error: any) {
    console.error('æäº¤ä»»åŠ¡å¤±è´¥:', error);
    this.setData({ parsing: false });
    this.showMessage(error.message || 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
  }
},

// è¯·æ±‚è®¢é˜…æ¶ˆæ¯æˆæƒ
async requestSubscriptionPermission() {
  try {
    const app = getApp();
    const config = await app.waitForConfigReady();
    
    const templateIds = [
      config.subscriptionTemplateIds?.success || 'default_success_template_id',
      config.subscriptionTemplateIds?.failed || 'default_failed_template_id'
    ];
    
    const result = await wx.requestSubscribeMessage({
      tmplIds: templateIds
    });
    
    console.log('è®¢é˜…æ¶ˆæ¯æˆæƒç»“æœ:', result);
    return result;
  } catch (error) {
    console.error('è®¢é˜…æ¶ˆæ¯æˆæƒå¤±è´¥:', error);
    // ä¸é˜»æ–­ä¸»æµç¨‹
    return null;
  }
},

// å¼€å§‹ç›‘å¬ä»»åŠ¡çŠ¶æ€
startTaskMonitoring(taskId: string) {
  const db = wx.cloud.database();
  
  console.log('å¼€å§‹ç›‘å¬ä»»åŠ¡:', taskId);
  
  // å®æ—¶æ•°æ®åº“ç›‘å¬
  const watcher = db.collection('tasks').doc(taskId).watch({
    onChange: (snapshot) => {
      if (snapshot.docs.length === 0) return;
      
      const task = snapshot.docs[0];
      console.log('ä»»åŠ¡çŠ¶æ€æ›´æ–°:', task.status);
      
      this.handleTaskUpdate(task, watcher);
    },
    onError: (error) => {
      console.error('ç›‘å¬ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
      // ç›‘å¬å¤±è´¥æ—¶å¯ç”¨è½®è¯¢å…œåº•
      this.startPollingFallback(taskId);
    }
  });
  
  // è®¾ç½®ç›‘å¬è¶…æ—¶ï¼ˆ10åˆ†é’Ÿï¼‰
  setTimeout(() => {
    if (watcher) {
      watcher.close();
      console.log('ä»»åŠ¡ç›‘å¬è¶…æ—¶ï¼Œè‡ªåŠ¨å…³é—­');
    }
  }, 10 * 60 * 1000);
},

// å¤„ç†ä»»åŠ¡çŠ¶æ€æ›´æ–°
handleTaskUpdate(task: any, watcher: any) {
  switch (task.status) {
    case 'processing':
      this.showMessage(`å¤„ç†è¿›åº¦ ${task.progress || 0}%`, 'info');
      break;
      
    case 'completed':
      // ä»»åŠ¡å®Œæˆ
      this.showTaskCompleted(task);
      watcher.close();
      break;
      
    case 'failed':
      // ä»»åŠ¡å¤±è´¥
      this.showTaskFailed(task);
      watcher.close();
      break;
      
    case 'timeout':
      // ä»»åŠ¡è¶…æ—¶
      this.showMessage('è§£æè¶…æ—¶ï¼Œè¯·é‡è¯•', 'error');
      watcher.close();
      break;
  }
},

// æ˜¾ç¤ºä»»åŠ¡å®Œæˆç»“æœ
showTaskCompleted(task: any) {
  console.log('ä»»åŠ¡å®Œæˆ:', task.result);
  
  this.setData({
    showResult: true,
    isContentUnlocked: false, // é‡ç½®è§£é”çŠ¶æ€
    result: {
      cover: task.result.cover || '/static/imgs/index_icon.png',
      title: task.result.title || 'æœªè·å–åˆ°æ ‡é¢˜',
      content: task.result.content || 'æœªè·å–åˆ°å†…å®¹',
      url: task.result.video_url || task.input_url
    }
  }, () => {
    this.updateDisplayContent();
  });
  
  this.showMessage('æ–‡æ¡ˆæå–æˆåŠŸï¼', 'success');
  
  // æ›´æ–°ç”¨æˆ·æå–æ¬¡æ•°
  this.updateUserExtractCount();
},

// æ˜¾ç¤ºä»»åŠ¡å¤±è´¥
showTaskFailed(task: any) {
  const errorMessage = task.error_message || 'è§£æå¤±è´¥ï¼Œè¯·é‡è¯•';
  this.showMessage(errorMessage, 'error');
},

// è½®è¯¢å…œåº•æ–¹æ¡ˆ
startPollingFallback(taskId: string) {
  console.log('å¯ç”¨è½®è¯¢å…œåº•æ–¹æ¡ˆ');
  
  let attempts = 0;
  const maxAttempts = 20; // æœ€å¤šè½®è¯¢20æ¬¡ï¼ˆ10åˆ†é’Ÿï¼‰
  
  const pollTimer = setInterval(async () => {
    attempts++;
    
    try {
      const db = wx.cloud.database();
      const result = await db.collection('tasks').doc(taskId).get();
      
      if (result.data) {
        const task = result.data;
        
        if (task.status === 'completed' || task.status === 'failed' || task.status === 'timeout') {
          clearInterval(pollTimer);
          this.handleTaskUpdate(task, null);
        }
      }
      
      if (attempts >= maxAttempts) {
        clearInterval(pollTimer);
        this.showMessage('è§£æè¶…æ—¶ï¼Œè¯·é‡è¯•', 'error');
      }
      
    } catch (error) {
      console.error('è½®è¯¢æŸ¥è¯¢å¤±è´¥:', error);
      
      if (attempts >= maxAttempts) {
        clearInterval(pollTimer);
        this.showMessage('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•', 'error');
      }
    }
  }, 30000); // 30ç§’è½®è¯¢ä¸€æ¬¡
}
```

### 2. é¡µé¢ç”Ÿå‘½å‘¨æœŸç®¡ç†

```typescript
// miniprogram/pages/index/index.ts

// é¡µé¢æ˜¾ç¤ºæ—¶æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„ä»»åŠ¡
onShow() {
  this.checkPendingTasks();
},

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è¿›è¡Œä¸­çš„ä»»åŠ¡
async checkPendingTasks() {
  try {
    const db = wx.cloud.database();
    const result = await db.collection('tasks')
      .where({
        status: db.command.in(['pending', 'processing'])
      })
      .orderBy('created_at', 'desc')
      .limit(1)
      .get();
    
    if (result.data.length > 0) {
      const pendingTask = result.data[0];
      console.log('å‘ç°è¿›è¡Œä¸­çš„ä»»åŠ¡:', pendingTask._id);
      
      // ç»§ç»­ç›‘å¬è¿™ä¸ªä»»åŠ¡
      this.startTaskMonitoring(pendingTask._id);
      this.showMessage('æ£€æµ‹åˆ°è¿›è¡Œä¸­çš„ä»»åŠ¡ï¼Œç»§ç»­ç›‘å¬...', 'info');
    }
  } catch (error) {
    console.error('æ£€æŸ¥å¾…å¤„ç†ä»»åŠ¡å¤±è´¥:', error);
  }
},

// é¡µé¢éšè—æ—¶çš„æ¸…ç†
onHide() {
  // æ¸…ç†ç›‘å¬å™¨
  if (this.taskWatcher) {
    this.taskWatcher.close();
    this.taskWatcher = null;
  }
},
```

### 3. ä»»åŠ¡å†å²ç®¡ç†

```typescript
// æŸ¥çœ‹å†å²ä»»åŠ¡
async showTaskHistory() {
  try {
    const db = wx.cloud.database();
    const result = await db.collection('tasks')
      .orderBy('created_at', 'desc')
      .limit(10)
      .get();
    
    console.log('å†å²ä»»åŠ¡:', result.data);
    
    // æ˜¾ç¤ºä»»åŠ¡åˆ—è¡¨å¯¹è¯æ¡†
    const taskList = result.data.map(task => {
      const status = this.getTaskStatusText(task.status);
      const time = task.created_at.toLocaleString();
      return `${status} - ${time}`;
    });
    
    wx.showActionSheet({
      itemList: taskList,
      success: (res) => {
        const selectedTask = result.data[res.tapIndex];
        if (selectedTask.status === 'completed') {
          // æ˜¾ç¤ºå†å²ä»»åŠ¡ç»“æœ
          this.showHistoryTaskResult(selectedTask);
        }
      }
    });
    
  } catch (error) {
    console.error('è·å–å†å²ä»»åŠ¡å¤±è´¥:', error);
    this.showMessage('è·å–å†å²è®°å½•å¤±è´¥', 'error');
  }
},

// è·å–ä»»åŠ¡çŠ¶æ€æ–‡æœ¬
getTaskStatusText(status: string): string {
  const statusMap = {
    'pending': 'ç­‰å¾…ä¸­',
    'processing': 'å¤„ç†ä¸­',
    'completed': 'å·²å®Œæˆ',
    'failed': 'å¤±è´¥',
    'timeout': 'è¶…æ—¶',
    'cancelled': 'å·²å–æ¶ˆ'
  };
  return statusMap[status] || 'æœªçŸ¥çŠ¶æ€';
},
```

## ğŸ® ç”¨æˆ·ä½“éªŒæå‡

### 1. è¿›åº¦æç¤ºä¼˜åŒ–

```typescript
// æ›´ä¸°å¯Œçš„è¿›åº¦æç¤º
updateTaskProgress(task: any) {
  const progress = task.progress || 0;
  const statusMessages = {
    0: 'æ­£åœ¨æ’é˜Ÿç­‰å¾…å¤„ç†...',
    20: 'æ­£åœ¨ä¸‹è½½è§†é¢‘æ–‡ä»¶...',
    40: 'æ­£åœ¨åˆ†æè§†é¢‘å†…å®¹...',
    60: 'æ­£åœ¨æå–æ–‡æ¡ˆä¿¡æ¯...',
    80: 'æ­£åœ¨ç”Ÿæˆæœ€ç»ˆç»“æœ...',
    100: 'å¤„ç†å®Œæˆï¼'
  };
  
  const message = statusMessages[Math.floor(progress / 20) * 20] || `å¤„ç†è¿›åº¦ ${progress}%`;
  this.showMessage(message, 'info');
}
```

### 2. é”™è¯¯å¤„ç†ä¼˜åŒ–

```typescript
// æ™ºèƒ½é”™è¯¯å¤„ç†å’Œé‡è¯•
handleTaskError(task: any) {
  const retryCount = task.retry_count || 0;
  const maxRetries = 2;
  
  if (retryCount < maxRetries) {
    // å…è®¸é‡è¯•
    wx.showModal({
      title: 'å¤„ç†å¤±è´¥',
      content: `${task.error_message}\n\næ˜¯å¦é‡è¯•ï¼Ÿï¼ˆè¿˜å¯é‡è¯• ${maxRetries - retryCount} æ¬¡ï¼‰`,
      confirmText: 'é‡è¯•',
      cancelText: 'å–æ¶ˆ',
      success: (res) => {
        if (res.confirm) {
          this.retryTask(task._id);
        }
      }
    });
  } else {
    // é‡è¯•æ¬¡æ•°å·²ç”¨å®Œ
    this.showMessage(`å¤„ç†å¤±è´¥ï¼š${task.error_message}`, 'error');
  }
}
```

## ğŸ“Š æ€§èƒ½ç›‘æ§

```typescript
// ç›‘æ§ä»»åŠ¡å¤„ç†æ—¶é—´
monitorTaskPerformance(task: any) {
  if (task.status === 'completed' && task.created_at && task.completed_at) {
    const processingTime = new Date(task.completed_at).getTime() - new Date(task.created_at).getTime();
    const seconds = Math.round(processingTime / 1000);
    
    console.log(`ä»»åŠ¡å¤„ç†è€—æ—¶: ${seconds}ç§’`);
    
    // ä¸ŠæŠ¥æ€§èƒ½æ•°æ®ï¼ˆå¯é€‰ï¼‰
    wx.reportMonitor('task_processing_time', seconds);
  }
}
```

è¿™æ ·å®ç°åï¼Œç”¨æˆ·ä½“éªŒå°†å¤§å¤§æå‡ï¼š
- âš¡ **ç«‹å³åé¦ˆ**ï¼šæäº¤åç«‹å³å‘ŠçŸ¥ç”¨æˆ·ä»»åŠ¡å·²æ¥æ”¶
- ğŸ”” **æ™ºèƒ½é€šçŸ¥**ï¼šå¾®ä¿¡æ¶ˆæ¯é€šçŸ¥ + å®æ—¶æ•°æ®ç›‘å¬
- ğŸ”„ **å®¹é”™å¤„ç†**ï¼šå¤šé‡å…œåº•æœºåˆ¶ç¡®ä¿å¯é æ€§
- ğŸ“± **åå°å¤„ç†**ï¼šç”¨æˆ·å¯ä»¥å…³é—­é¡µé¢ï¼Œä¸å½±å“ä»»åŠ¡å¤„ç†
