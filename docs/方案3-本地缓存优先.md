# 方案3：本地缓存优先模式

## 🎯 核心思路
先使用本地缓存的配置立即渲染页面，后台网络请求完成后再更新。

## 📝 代码实现

### 1. 在 app.ts 中添加缓存管理

```typescript
// app.ts 新增方法
loadCachedConfig(): AppConfig {
  try {
    const cachedConfig = wx.getStorageSync('app_config');
    if (cachedConfig) {
      console.log('使用缓存配置:', cachedConfig);
      this.globalData.appConfig = cachedConfig;
      return cachedConfig;
    }
  } catch (error) {
    console.error('读取缓存配置失败:', error);
  }
  
  // 缓存不存在时使用默认配置
  return this.loadDefaultConfigSync();
}

loadDefaultConfigSync(): AppConfig {
  const defaultConfig = {
    // ... 默认配置
  };
  this.globalData.appConfig = defaultConfig;
  return defaultConfig;
}

// 修改 silentLogin 保存配置到缓存
async silentLogin() {
  // 1. 先加载缓存配置，立即可用
  this.loadCachedConfig();
  this._markConfigReady(this.globalData.appConfig!);
  
  try {
    // 2. 后台请求最新配置
    const loginResult = await wx.cloud.callFunction({
      name: 'login'
    });
    
    const result = loginResult.result as any;
    if (result?.appConfig) {
      // 3. 保存最新配置到缓存
      wx.setStorageSync('app_config', result.appConfig);
      
      // 4. 更新全局配置
      this.globalData.appConfig = result.appConfig;
      console.log('配置已更新:', result.appConfig);
      
      // 5. 通知页面配置已更新（可选）
      this._notifyConfigUpdated?.(result.appConfig);
    }
  } catch (error) {
    console.error('获取最新配置失败:', error);
    // 缓存配置已经可用，不影响用户体验
  }
}
```

### 2. 在页面中使用缓存优先模式

```typescript
// index.ts
loadConfigSettings() {
  const app = getApp();
  
  // 1. 立即使用当前配置（可能是缓存的）
  const config = app.getAppConfig();
  if (config) {
    console.log('使用配置（可能是缓存）:', config);
    this.setData({
      homeFooterInfo1: config.homeFooterInfo1,
      homeFooterInfo2: config.homeFooterInfo2
    });
  }
  
  // 2. 可选：监听配置更新
  app.onConfigUpdated?.((newConfig) => {
    console.log('配置已更新，刷新页面显示');
    this.setData({
      homeFooterInfo1: newConfig.homeFooterInfo1,
      homeFooterInfo2: newConfig.homeFooterInfo2
    });
  });
}
```

## ✅ 优势
- ⚡ 用户体验最佳，无等待时间
- 📱 离线可用，网络异常时有备用方案  
- 🔄 后台静默更新，用户无感知
- 💾 减少网络请求，提升性能

## ❌ 劣势
- 💾 需要管理本地存储
- 🔄 可能显示旧配置（首次更新前）
- 🔧 代码逻辑稍微复杂
