# 视频文案提取功能使用指南

## 功能概述

本系统已成功集成 Coze API，实现视频文案自动提取功能。采用前后端分离的轮询架构，确保稳定性和用户体验。

## 架构特点

### 🔄 **分离式轮询架构**
- **云函数**: 负责单次任务发送和查询
- **前端**: 负责轮询逻辑和状态管理
- **优势**: 避免云函数超时，更好的用户体验

### 📱 **用户体验优化**
- 使用 `t-message` 组件替代 loading 提示
- 实时显示解析进度
- 智能错误提示和重试机制

## 技术实现

### 云函数 (`extractText`)

#### 1. 发送任务 (`sendTask`)
```javascript
// 调用方式
wx.cloud.callFunction({
  name: 'extractText',
  data: { 
    action: 'sendTask',
    input: '视频链接' 
  }
})

// 返回结果
{
  success: true,
  data: { executeId: '7537989579166810139' }
}
```

#### 2. 查询任务 (`queryTask`)
```javascript
// 调用方式
wx.cloud.callFunction({
  name: 'extractText',
  data: { 
    action: 'queryTask',
    executeId: '7537989579166810139' 
  }
})

// 返回结果 - 成功
{
  success: true,
  status: 'success',
  data: {
    content: '提取的文案内容',
    photo: '视频封面URL',
    title: '视频标题',
    url: '原视频URL'
  }
}

// 返回结果 - 执行中
{
  success: false,
  status: 'running',
  message: '任务执行中...'
}

// 返回结果 - 失败
{
  success: false,
  status: 'failed',
  error: '任务执行失败'
}
```

### 前端实现 (`index.ts`)

#### 1. 主解析流程
```typescript
async onParse() {
  // 1. 验证输入
  // 2. 发送任务
  // 3. 轮询查询
  // 4. 处理结果
  // 5. 更新UI
}
```

#### 2. 轮询查询方法
```typescript
async pollTaskResult(executeId: string, maxAttempts = 30, interval = 2000) {
  // 循环查询直到成功、失败或超时
  // 显示实时进度
  // 智能错误处理
}
```

## 支持的平台

- ✅ **抖音**: douyin.com, dy.com, v.douyin.com
- ✅ **小红书**: xiaohongshu.com, xhslink.com  
- ✅ **B站**: bilibili.com, b23.tv
- ✅ **快手**: kuaishou.com, ks.com

## 用户交互流程

1. **输入链接** → 验证格式 → 检查用户登录状态
2. **发送任务** → 显示"正在发送提取任务..."
3. **任务发送成功** → 显示"任务已发送，正在解析视频内容..."
4. **轮询查询** → 显示进度 "解析进度 X%，请耐心等待..."
5. **解析完成** → 显示"文案提取成功！"
6. **展示结果** → 弹框显示视频信息和文案
7. **用户操作** → 复制文案 / 下载视频

## 错误处理

### 输入验证
- 空链接检查
- 链接格式验证
- 用户登录状态检查

### 网络错误
- 云函数调用失败
- API 接口异常
- 超时处理

### 业务错误
- 任务发送失败
- 解析任务失败
- 结果格式错误

## 性能优化

### 轮询策略
- **最大尝试次数**: 30次
- **查询间隔**: 2秒
- **总超时时间**: 约60秒
- **进度显示**: 实时更新

### 用户体验
- 非阻塞式提示
- 智能进度显示
- 错误分类提示
- 自动清空输入框

## 部署配置

### 1. 云函数配置
```bash
# 进入云函数目录
cd cloudfunctions/extractText

# 安装依赖
npm install

# 上传部署
# 在微信开发者工具中右键上传并部署
```

### 2. API 配置
- 确保 `COZE_CONFIG.AUTH_TOKEN` 正确
- 确保 `COZE_CONFIG.WORKFLOW_ID` 正确
- 检查 API 访问权限

### 3. 前端配置
- 确保云函数名称正确: `extractText`
- 确保 `t-message` 组件已正确引入

## 监控和日志

### 云函数日志
- 任务发送日志
- 查询结果日志  
- 错误异常日志

### 前端日志
- 解析流程日志
- 轮询状态日志
- 用户操作日志

## 故障排查

### 常见问题

1. **"发送任务失败"**
   - 检查云函数部署状态
   - 检查 API Token 是否有效
   - 检查网络连接

2. **"任务查询超时"**
   - 检查 Coze API 服务状态
   - 适当增加轮询次数
   - 检查视频链接有效性

3. **"解析失败"**
   - 验证视频链接格式
   - 检查视频平台支持
   - 查看云函数错误日志

### 调试模式
在开发者工具中查看:
- 云函数调用日志
- Network 请求状态
- Console 错误信息

## 扩展建议

### 功能扩展
- 支持更多视频平台
- 添加文案质量评估
- 实现批量处理功能

### 性能优化
- 实现智能重试机制
- 添加本地缓存功能
- 优化轮询算法

### 用户体验
- 添加解析历史记录
- 实现文案编辑功能
- 支持多种导出格式