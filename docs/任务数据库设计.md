# ğŸ“Š ä»»åŠ¡æ•°æ®åº“è®¾è®¡è¯¦ç»†è¯´æ˜

## ğŸ—ƒï¸ é›†åˆç»“æ„ï¼štasks

### å®Œæ•´å­—æ®µå®šä¹‰

```json
{
  "_id": "string (äº‘æ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆçš„ä»»åŠ¡ID)",
  "_openid": "string (ç”¨æˆ·openidï¼Œäº‘å¼€å‘è‡ªåŠ¨æ³¨å…¥)",
  "task_uuid": "string (è‡ªå®šä¹‰ä»»åŠ¡UUIDï¼Œç”¨äºwebhookè¯†åˆ«)",
  "status": "string (ä»»åŠ¡çŠ¶æ€æšä¸¾)",
  "coze_execute_id": "string (Coze APIè¿”å›çš„æ‰§è¡ŒID)",
  "input_url": "string (ç”¨æˆ·è¾“å…¥çš„è§†é¢‘é“¾æ¥)",
  "result": {
    "title": "string (è§†é¢‘æ ‡é¢˜)",
    "content": "string (æå–çš„æ–‡æ¡ˆå†…å®¹)",
    "cover": "string (è§†é¢‘å°é¢å›¾ç‰‡URL)",
    "video_url": "string (å¤„ç†åçš„è§†é¢‘ä¸‹è½½é“¾æ¥)"
  },
  "error_message": "string (é”™è¯¯ä¿¡æ¯ï¼Œå¤±è´¥æ—¶è®°å½•)",
  "progress": "number (å¤„ç†è¿›åº¦ 0-100)",
  "retry_count": "number (é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤0)",
  "webhook_received": "boolean (æ˜¯å¦å·²æ”¶åˆ°webhookå›è°ƒ)",
  "notification_sent": "boolean (æ˜¯å¦å·²å‘é€è®¢é˜…æ¶ˆæ¯)",
  "created_at": "Date (ä»»åŠ¡åˆ›å»ºæ—¶é—´)",
  "updated_at": "Date (æœ€åæ›´æ–°æ—¶é—´)",
  "started_at": "Date (å¼€å§‹å¤„ç†æ—¶é—´)",
  "completed_at": "Date (å®Œæˆæ—¶é—´)",
  "expires_at": "Date (ä»»åŠ¡è¿‡æœŸæ—¶é—´ï¼Œåˆ›å»ºå24å°æ—¶)"
}
```

### çŠ¶æ€æšä¸¾è¯´æ˜

| çŠ¶æ€ | è¯´æ˜ | ç”¨æˆ·å¯è§ | åç»­æ“ä½œ |
|------|------|----------|----------|
| `pending` | ä»»åŠ¡å·²åˆ›å»ºï¼Œç­‰å¾…å¤„ç† | "æ­£åœ¨æ’é˜Ÿ..." | è°ƒç”¨Coze API |
| `processing` | æ­£åœ¨å¤„ç†ä¸­ | "æ­£åœ¨è§£æè§†é¢‘..." | ç­‰å¾…webhook |
| `completed` | å¤„ç†å®Œæˆ | "è§£æå®Œæˆï¼" | æ˜¾ç¤ºç»“æœ |
| `failed` | å¤„ç†å¤±è´¥ | "è§£æå¤±è´¥" | å…è®¸é‡è¯• |
| `timeout` | å¤„ç†è¶…æ—¶ | "è§£æè¶…æ—¶" | å…è®¸é‡è¯• |
| `cancelled` | ç”¨æˆ·å–æ¶ˆ | "å·²å–æ¶ˆ" | æ—  |

### ç´¢å¼•å»ºè®®

```javascript
// å»ºè®®åˆ›å»ºçš„ç´¢å¼•
{
  "_openid": 1,           // ç”¨æˆ·æŸ¥è¯¢ä»»åŠ¡
  "status": 1,            // çŠ¶æ€æŸ¥è¯¢
  "task_uuid": 1,         // webhookæŸ¥è¯¢ (å”¯ä¸€)
  "coze_execute_id": 1,   // Coze IDæŸ¥è¯¢ (å”¯ä¸€)
  "created_at": -1,       // æ—¶é—´æ’åº
  "expires_at": 1         // æ¸…ç†è¿‡æœŸä»»åŠ¡
}
```

## ğŸ”„ çŠ¶æ€æµè½¬å›¾

```mermaid
graph TD
    A[pending] --> B[processing]
    B --> C[completed]
    B --> D[failed]
    B --> E[timeout]
    A --> F[cancelled]
    D --> B
    E --> B
    D --> F
    E --> F
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºä»»åŠ¡
```javascript
const taskData = {
  task_uuid: generateUUID(),
  status: 'pending',
  coze_execute_id: executeId,
  input_url: userInputUrl,
  result: null,
  error_message: null,
  progress: 0,
  retry_count: 0,
  webhook_received: false,
  notification_sent: false,
  created_at: new Date(),
  updated_at: new Date(),
  expires_at: new Date(Date.now() + 24 * 60 * 60 * 1000) // 24å°æ—¶åè¿‡æœŸ
};
```

### æ›´æ–°ä»»åŠ¡çŠ¶æ€
```javascript
await db.collection('tasks').doc(taskId).update({
  data: {
    status: 'completed',
    result: extractedData,
    completed_at: new Date(),
    updated_at: new Date()
  }
});
```

### æŸ¥è¯¢ç”¨æˆ·ä»»åŠ¡
```javascript
const userTasks = await db.collection('tasks')
  .where({
    _openid: userOpenid,
    status: _.in(['pending', 'processing'])
  })
  .orderBy('created_at', 'desc')
  .get();
```
