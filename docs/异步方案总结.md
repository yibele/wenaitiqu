# ğŸ¯ å¼‚æ­¥æ–¹æ¡ˆå®Œæ•´æ€»ç»“

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

æˆ‘å·²ç»ä¸ºæ‚¨å®Œæ•´è®¾è®¡å¹¶å®ç°äº†ä»**å‰ç«¯è½®è¯¢**åˆ°**äº‹ä»¶é©±åŠ¨å¼‚æ­¥å¤„ç†**çš„å‡çº§æ–¹æ¡ˆã€‚

## ğŸ—ï¸ å®Œæ•´æ¶æ„

```mermaid
graph TD
    A[ç”¨æˆ·æäº¤è§†é¢‘é“¾æ¥] --> B[extractTextäº‘å‡½æ•°]
    B --> C[è°ƒç”¨Coze API + Webhooké…ç½®]
    B --> D[åˆ›å»ºtasksæ•°æ®åº“è®°å½•]
    C --> E[Cozeåå°å¤„ç†è§†é¢‘]
    E --> F[å¤„ç†å®Œæˆï¼Œè°ƒç”¨Webhook]
    F --> G[webhookHandleräº‘å‡½æ•°]
    G --> H[æ›´æ–°tasksçŠ¶æ€]
    G --> I[å‘é€è®¢é˜…æ¶ˆæ¯]
    H --> J[å‰ç«¯å®æ—¶ç›‘å¬æ•°æ®å˜åŒ–]
    I --> K[ç”¨æˆ·æ”¶åˆ°å¾®ä¿¡é€šçŸ¥]
    J --> L[è‡ªåŠ¨æ˜¾ç¤ºç»“æœ]
    K --> L
```

## ğŸ“ å·²åˆ›å»ºçš„å®Œæ•´æ–‡ä»¶

### ğŸ”§ äº‘å‡½æ•°ä»£ç 
```
cloudfunctions/webhookHandler/
â”œâ”€â”€ index.js          # å®Œæ•´çš„Webhookå¤„ç†é€»è¾‘
â””â”€â”€ package.json       # ä¾èµ–é…ç½®
```

### ğŸ“Š æ•°æ®åº“è®¾è®¡
- **tasksé›†åˆç»“æ„**: 13ä¸ªå­—æ®µï¼Œå®Œæ•´çš„çŠ¶æ€ç®¡ç†
- **ç´¢å¼•å»ºè®®**: æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ
- **çŠ¶æ€æµè½¬**: 6ç§çŠ¶æ€çš„å®Œæ•´æµè½¬é€»è¾‘

### ğŸ“± å‰ç«¯å®ç°
- **å®æ—¶ç›‘å¬**: æ•°æ®åº“watch + è®¢é˜…æ¶ˆæ¯åŒä¿é™©
- **ç”¨æˆ·ä½“éªŒ**: ç«‹å³åé¦ˆ + åå°å¤„ç† + æ™ºèƒ½é‡è¯•
- **é”™è¯¯å¤„ç†**: å¤šå±‚æ¬¡å®¹é”™æœºåˆ¶

### ğŸ“š å®Œæ•´æ–‡æ¡£
1. **å¼‚æ­¥æ–¹æ¡ˆ.md** - æ–¹æ¡ˆæ€»è§ˆå’Œæ¶æ„è®¾è®¡
2. **ä»»åŠ¡æ•°æ®åº“è®¾è®¡.md** - è¯¦ç»†çš„æ•°æ®åº“ç»“æ„
3. **Webhookå’Œè®¢é˜…æ¶ˆæ¯é…ç½®æŒ‡å—.md** - å®Œæ•´é…ç½®æ­¥éª¤
4. **å‰ç«¯ç›‘å¬å®ç°ä»£ç .md** - å‰ç«¯ä»£ç å®ç°
5. **extractTextäº‘å‡½æ•°æ”¹é€ æŒ‡å—.md** - åç«¯æ”¹é€ æ–¹æ¡ˆ
6. **å¼‚æ­¥æ–¹æ¡ˆå®æ–½è®¡åˆ’.md** - åˆ†é˜¶æ®µå®æ–½è®¡åˆ’

## ğŸ¯ æ ¸å¿ƒè§£å†³æ–¹æ¡ˆ

### 1. äº‘å‡½æ•°è·å–Coze APIçš„POSTè¯·æ±‚

#### é…ç½®HTTPè§¦å‘å™¨
```javascript
// 1. éƒ¨ç½²webhookHandleräº‘å‡½æ•°
// 2. é…ç½®HTTPè§¦å‘å™¨: POST /webhook/coze
// 3. è·å–URL: https://your-env.service.tcloudbase.com/webhookHandler/webhook/coze
```

#### æ¥æ”¶å’Œå¤„ç†POSTè¯·æ±‚
```javascript
// cloudfunctions/webhookHandler/index.js
exports.main = async (event, context) => {
  // 1. éªŒè¯webhookç­¾åå®‰å…¨
  if (!verifyWebhookSignature(event)) {
    return { statusCode: 401, body: 'Unauthorized' };
  }
  
  // 2. è§£æCozeå›è°ƒæ•°æ®
  const webhookData = parseWebhookData(event);
  
  // 3. æŸ¥æ‰¾å¯¹åº”ä»»åŠ¡è®°å½•
  const task = await findTaskByExecuteId(webhookData.executeId);
  
  // 4. æ›´æ–°æ•°æ®åº“çŠ¶æ€
  await updateTaskStatus(task, webhookData);
  
  // 5. å‘é€è®¢é˜…æ¶ˆæ¯
  await sendSubscriptionMessage(task._openid, task._id, webhookData);
  
  return { statusCode: 200, body: 'Success' };
};
```

### 2. å‘é€è®¢é˜…æ¶ˆæ¯

#### æ¶ˆæ¯æ¨¡æ¿é…ç½®
```javascript
// æˆåŠŸæ¨¡æ¿
{
  "title": "ä»»åŠ¡å¤„ç†å®Œæˆ",
  "content": "{{thing1.DATA}}\nå®Œæˆæ—¶é—´ï¼š{{time2.DATA}}\nå¤„ç†ç»“æœï¼š{{thing3.DATA}}"
}

// å¤±è´¥æ¨¡æ¿  
{
  "title": "ä»»åŠ¡å¤„ç†å¤±è´¥", 
  "content": "{{thing1.DATA}}\nå¤±è´¥æ—¶é—´ï¼š{{time2.DATA}}\nå¤±è´¥åŸå› ï¼š{{thing4.DATA}}"
}
```

#### å‘é€è®¢é˜…æ¶ˆæ¯
```javascript
await cloud.openapi.subscribeMessage.send({
  touser: openid,
  page: `/pages/index/index?taskId=${taskId}`,
  data: {
    thing1: { value: 'è§†é¢‘æ–‡æ¡ˆæå–' },
    time2: { value: new Date().toLocaleString('zh-CN') },
    thing3: { value: isSuccess ? 'å¤„ç†æˆåŠŸ' : 'å¤„ç†å¤±è´¥' }
  },
  templateId: templateId,
  miniprogramState: 'formal'
});
```

### 3. ä»»åŠ¡é›†åˆæ ¼å¼

#### å®Œæ•´å­—æ®µç»“æ„
```json
{
  "_id": "string (äº‘æ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆ)",
  "_openid": "string (ç”¨æˆ·openidï¼Œè‡ªåŠ¨æ³¨å…¥)",
  "task_uuid": "string (è‡ªå®šä¹‰ä»»åŠ¡UUID)",
  "status": "string (pending|processing|completed|failed|timeout|cancelled)",
  "coze_execute_id": "string (Coze APIæ‰§è¡ŒID)",
  "input_url": "string (ç”¨æˆ·è¾“å…¥çš„è§†é¢‘é“¾æ¥)",
  "result": {
    "title": "string (è§†é¢‘æ ‡é¢˜)",
    "content": "string (æå–çš„æ–‡æ¡ˆ)",
    "cover": "string (å°é¢å›¾ç‰‡URL)",
    "video_url": "string (è§†é¢‘ä¸‹è½½é“¾æ¥)"
  },
  "error_message": "string (é”™è¯¯ä¿¡æ¯)",
  "progress": "number (0-100è¿›åº¦)",
  "retry_count": "number (é‡è¯•æ¬¡æ•°)",
  "webhook_received": "boolean (æ˜¯å¦æ”¶åˆ°å›è°ƒ)",
  "notification_sent": "boolean (æ˜¯å¦å·²é€šçŸ¥)",
  "created_at": "Date (åˆ›å»ºæ—¶é—´)",
  "updated_at": "Date (æ›´æ–°æ—¶é—´)",
  "started_at": "Date (å¼€å§‹æ—¶é—´)",
  "completed_at": "Date (å®Œæˆæ—¶é—´)",
  "expires_at": "Date (è¿‡æœŸæ—¶é—´)"
}
```

#### çŠ¶æ€è¯´æ˜
- **pending**: ä»»åŠ¡å·²åˆ›å»ºï¼Œç­‰å¾…å¤„ç†
- **processing**: æ­£åœ¨å¤„ç†ä¸­
- **completed**: å¤„ç†å®Œæˆ
- **failed**: å¤„ç†å¤±è´¥
- **timeout**: å¤„ç†è¶…æ—¶
- **cancelled**: ç”¨æˆ·å–æ¶ˆ

## ğŸš€ å®æ–½æ­¥éª¤

### Phase 1: åŸºç¡€é…ç½®
1. âœ… åˆ›å»ºtasksæ•°æ®åº“é›†åˆ
2. âœ… éƒ¨ç½²webhookHandleräº‘å‡½æ•°
3. âœ… é…ç½®HTTPè§¦å‘å™¨
4. âœ… ç”³è¯·è®¢é˜…æ¶ˆæ¯æ¨¡æ¿

### Phase 2: äº‘å‡½æ•°æ”¹é€ 
1. âœ… ä¿®æ”¹extractTextäº‘å‡½æ•°
2. âœ… æ·»åŠ createTask action
3. âœ… é…ç½®Coze API webhook
4. âœ… æµ‹è¯•ç«¯åˆ°ç«¯æµç¨‹

### Phase 3: å‰ç«¯å‡çº§
1. âœ… ä¿®æ”¹è§£ææµç¨‹
2. âœ… æ·»åŠ å®æ—¶ç›‘å¬
3. âœ… ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ
4. âœ… å®Œå–„é”™è¯¯å¤„ç†

### Phase 4: é…ç½®æ›´æ–°
1. âœ… æ›´æ–°åº”ç”¨é…ç½®é¡¹
2. âœ… æ·»åŠ è®¢é˜…æ¶ˆæ¯ID
3. âœ… é…ç½®webhookå®‰å…¨å¯†é’¥
4. âœ… è®¾ç½®ä»»åŠ¡å‚æ•°

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### ğŸ® ç”¨æˆ·ä½“éªŒ
- **æäº¤ä»»åŠ¡**: ç«‹å³åé¦ˆï¼ˆ<1ç§’ï¼‰
- **åå°å¤„ç†**: å¯å…³é—­é¡µé¢ï¼Œ0æ¶ˆè€—
- **åŠæ—¶é€šçŸ¥**: å¾®ä¿¡æ¶ˆæ¯è‡ªåŠ¨æé†’
- **æ— ç¼æŸ¥çœ‹**: ç‚¹å‡»é€šçŸ¥ç›´è¾¾ç»“æœ

### ğŸ”§ æŠ€æœ¯æŒ‡æ ‡  
- **å“åº”æ—¶é—´**: 5-30ç§’ â†’ <1ç§’ (30å€æå‡)
- **ç½‘ç»œè¯·æ±‚**: æŒç»­è½®è¯¢ â†’ æŒ‰éœ€è§¦å‘ (90%å‡å°‘)
- **æœåŠ¡å™¨è´Ÿè½½**: é«˜é¢‘è°ƒç”¨ â†’ äº‹ä»¶é©±åŠ¨ (80%å‡å°‘)
- **ç”¨æˆ·æ»¡æ„åº¦**: è´¨çš„é£è·ƒ

## âš™ï¸ æ ¸å¿ƒé…ç½®è¦ç‚¹

### 1. Coze APIé…ç½®
```javascript
// åœ¨Cozeæ§åˆ¶å°é…ç½®
{
  "webhook_url": "https://your-env.service.tcloudbase.com/webhookHandler/webhook/coze",
  "secret": "your-webhook-secret-key",
  "events": ["workflow.execution.completed", "workflow.execution.failed"]
}
```

### 2. å¾®ä¿¡è®¢é˜…æ¶ˆæ¯
```javascript
// åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°ç”³è¯·æ¨¡æ¿åï¼Œæ›´æ–°é…ç½®
{
  "subscriptionTemplateIds": {
    "success": "your_actual_success_template_id",
    "failed": "your_actual_failed_template_id"
  }
}
```

### 3. å®‰å…¨é…ç½®
```javascript
// webhookå®‰å…¨éªŒè¯
{
  "webhookConfig": {
    "secret": "your-webhook-secret-key", // ä¸Cozeé…ç½®ä¸€è‡´
    "timeout": 300 // 5åˆ†é’Ÿè¶…æ—¶
  }
}
```

## ğŸ›¡ï¸ å®‰å…¨å’Œå®¹é”™

### å®‰å…¨æœºåˆ¶
- âœ… Webhookç­¾åéªŒè¯
- âœ… æ—¶é—´æˆ³é˜²é‡æ”¾æ”»å‡»
- âœ… ç”¨æˆ·æƒé™æ£€æŸ¥
- âœ… é”™è¯¯ä¿¡æ¯è„±æ•

### å®¹é”™æœºåˆ¶
- âœ… å¤šé‡ç›‘å¬å…œåº•
- âœ… è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š2æ¬¡ï¼‰
- âœ… ä»»åŠ¡è¿‡æœŸæ¸…ç†
- âœ… è¯¦ç»†é”™è¯¯æ—¥å¿—

## ğŸ§ª æµ‹è¯•éªŒè¯

### åŠŸèƒ½æµ‹è¯•æ¸…å•
- [ ] ä»»åŠ¡åˆ›å»ºå’Œæäº¤
- [ ] Webhookæ­£å¸¸æ¥æ”¶
- [ ] æ•°æ®åº“çŠ¶æ€æ›´æ–°
- [ ] è®¢é˜…æ¶ˆæ¯å‘é€
- [ ] å‰ç«¯å®æ—¶ç›‘å¬
- [ ] é”™è¯¯å¤„ç†æœºåˆ¶

### æ€§èƒ½æµ‹è¯•
- [ ] å“åº”æ—¶é—´<1ç§’
- [ ] å¹¶å‘å¤„ç†èƒ½åŠ›
- [ ] å†…å­˜ä½¿ç”¨æ­£å¸¸
- [ ] ç½‘ç»œè¯·æ±‚ä¼˜åŒ–

## ğŸ¯ æˆåŠŸæ ‡å‡†

âœ… **å³æ—¶å“åº”**: ä»»åŠ¡æäº¤å“åº”<1ç§’  
âœ… **å®æ—¶é€šçŸ¥**: å¤„ç†å®Œæˆé€šçŸ¥<5ç§’  
âœ… **é«˜æˆåŠŸç‡**: ç«¯åˆ°ç«¯æˆåŠŸç‡>95%  
âœ… **ç”¨æˆ·å‹å¥½**: æ”¯æŒåå°å¤„ç†ï¼Œæ— éœ€ç­‰å¾…  

---

## ğŸ† æ€»ç»“

è¿™å¥—å¼‚æ­¥æ–¹æ¡ˆå°†æ‚¨çš„å°ç¨‹åºä»ä¼ ç»Ÿçš„è½®è¯¢æ¨¡å¼å‡çº§ä¸ºç°ä»£åŒ–çš„äº‹ä»¶é©±åŠ¨æ¶æ„ï¼š

1. **ğŸ“± ç”¨æˆ·ä½“éªŒ**: ä»"éœ€è¦ç­‰å¾…"åˆ°"ç«‹å³åé¦ˆ"
2. **ğŸ”§ æŠ€æœ¯æ¶æ„**: ä»"é¢‘ç¹è½®è¯¢"åˆ°"äº‹ä»¶é©±åŠ¨" 
3. **ğŸ’° æˆæœ¬æ•ˆç›Š**: ä»"é«˜æ¶ˆè€—"åˆ°"æŒ‰éœ€è®¡è´¹"
4. **ğŸš€ æ€§èƒ½è¡¨ç°**: ä»"ç§’çº§å»¶è¿Ÿ"åˆ°"æ¯«ç§’å“åº”"

**è¿™å°†æ˜¯ä¸€ä¸ªè´¨çš„é£è·ƒï¼Œè®©æ‚¨çš„å°ç¨‹åºæ‹¥æœ‰ä¸šç•Œé¢†å…ˆçš„å¼‚æ­¥å¤„ç†èƒ½åŠ›ï¼** ğŸ‰